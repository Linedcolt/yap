<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Supabase Realtime Chat (single file)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; display:flex; height:100vh;}
    #left{width:320px;border-right:1px solid #eee;padding:12px;box-sizing:border-box;}
    #main{flex:1;display:flex;flex-direction:column;}
    .room{padding:8px;border:1px solid #ddd;margin-bottom:8px;border-radius:6px;cursor:pointer;}
    .room.active{background:#f0f8ff}
    #messages{flex:1;overflow:auto;padding:12px;}
    .msg{margin-bottom:8px;padding:6px;border-radius:6px;}
    .meta{font-size:12px;color:#666}
    #composer{display:flex;padding:12px;border-top:1px solid #eee}
    #composer input[type="text"]{flex:1;padding:8px;margin-right:8px;border:1px solid #ccc;border-radius:6px}
    #composer button{padding:8px 12px}
    #signin{margin-bottom:12px}
    small.note{color:#666}
  </style>
</head>
<body>
  <div id="left">
    <div id="signin">
      <div id="auth-area">
        <div id="user-info"></div>
        <div id="auth-forms">
          <input id="email" placeholder="you@example.com" style="width:100%;padding:8px;margin-bottom:6px">
          <button id="magic-btn" style="width:100%">Send sign-in link</button>
          <div style="height:8px"></div>
        </div>
      </div>
    </div>

    <hr/>
    <div>
      <h4>Rooms</h4>
      <div id="rooms-list"></div>
      <input id="new-room-name" placeholder="New room name" style="width:100%;padding:8px;margin-top:8px">
      <button id="create-room" style="width:100%;margin-top:6px">Create room</button>
    </div>
  </div>

  <div id="main">
    <div style="padding:12px;border-bottom:1px solid #eee;">
      <strong id="room-title">No room</strong>
      <div style="float:right">
        <button id="invite-btn" style="display:none">Generate invite</button>
      </div>
      <div><small id="invite-url"></small></div>
    </div>

    <div id="messages"></div>

    <div id="composer">
      <input id="message-input" placeholder="Write a message..." disabled>
      <button id="send-btn" disabled>Send</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = 'https://<YOUR_SUPABASE_PROJECT>.supabase.co'; // <-- REPLACE
    const SUPABASE_ANON_KEY = '<YOUR_ANON_KEY>'; // <-- REPLACE

    const supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- simple state ----------
    let currentUser = null;
    let currentRoom = null;
    let subscription = null;

    // ---------- DOM ----------
    const userInfo = document.getElementById('user-info');
    const emailIn = document.getElementById('email');
    const magicBtn = document.getElementById('magic-btn');
    const roomsList = document.getElementById('rooms-list');
    const newRoomName = document.getElementById('new-room-name');
    const createRoomBtn = document.getElementById('create-room');
    const roomTitle = document.getElementById('room-title');
    const inviteBtn = document.getElementById('invite-btn');
    const inviteUrl = document.getElementById('invite-url');
    const messagesNode = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // ---------- auth UI ----------
    async function refreshAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      if (user) {
        userInfo.innerHTML = `<div><strong>${user.email || user.id}</strong><br><small>${user.id}</small><div style="margin-top:6px"><button id="signout">Sign out</button></div></div>`;
        document.getElementById('auth-forms').style.display = 'none';
        document.getElementById('signout').onclick = async () => {
          await supabase.auth.signOut();
          refreshAuth();
        };
        enableComposer(true);
      } else {
        userInfo.innerHTML = `<small class="note">Not signed in</small>`;
        document.getElementById('auth-forms').style.display = 'block';
        enableComposer(false);
      }
    }
    refreshAuth();

    magicBtn.addEventListener('click', async () => {
      const email = emailIn.value.trim();
      if (!email) return alert('enter email');
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) return alert(error.message);
      alert('Magic link sent — check your email. After signing in, reload this page.');
    });

    // handle redirect after magic link (if present)
    window.addEventListener('load', async () => {
      const hash = window.location.hash;
      if (hash.includes('access_token') || hash.includes('refresh_token')) {
        // supabase-js handles session automatically, but refresh UI
        await supabase.auth.getSessionFromUrl({ storeSession: true });
      }
      await refreshAuth();
      await loadRooms();
      // if there's an invite token in the query string, redeem it:
      const params = new URLSearchParams(window.location.search);
      const invite = params.get('invite');
      if (invite) {
        // try to join the invite
        try { await joinRoomFromInvite(invite); } catch(e){ console.error(e); alert('Failed to join invite: '+e.message); }
      }
    });

    // ---------- rooms ----------
    async function loadRooms() {
      const { data, error } = await supabase
        .from('rooms')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) return console.error(error);
      roomsList.innerHTML = '';
      data.forEach(r => {
        const el = document.createElement('div');
        el.className = 'room';
        el.textContent = r.name + (r.owner ? ' • owner' : '');
        el.onclick = () => selectRoom(r);
        roomsList.appendChild(el);
      });
    }

    createRoomBtn.addEventListener('click', async () => {
      const name = newRoomName.value.trim();
      if (!name) return alert('name required');
      const { data, error } = await supabase
        .from('rooms')
        .insert([{ name, owner: currentUser?.id || null }])
        .select()
        .single();
      if (error) return alert(error.message);
      // make creator a member (if signed in)
      if (currentUser) {
        await supabase.from('room_members').upsert([{ room_id: data.id, user_id: currentUser.id, username: currentUser.email || '' }]);
      }
      newRoomName.value = '';
      await loadRooms();
      selectRoom(data);
    });

    // ---------- select room / load messages / subscribe ----------
    async function selectRoom(room) {
      currentRoom = room;
      roomTitle.textContent = room.name;
      inviteBtn.style.display = 'inline-block';
      inviteUrl.textContent = '';
      // mark UI active
      Array.from(document.querySelectorAll('.room')).forEach(n => n.classList.remove('active'));
      // naive active marker by matching text:
      Array.from(document.querySelectorAll('.room')).forEach(n => { if (n.textContent.startsWith(room.name)) n.classList.add('active') });

      await loadMessages(room.id);
      subscribeToMessages(room.id);
    }

    async function loadMessages(room_id) {
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('room_id', room_id)
        .order('created_at', { ascending: true })
        .limit(500); // cap

      if (error) {
        console.error(error);
        messagesNode.innerHTML = '<div style="color:red">Could not load messages</div>';
        return;
      }
      messagesNode.innerHTML = '';
      data.forEach(appendMessage);
      messagesNode.scrollTop = messagesNode.scrollHeight;
    }

    function appendMessage(m) {
      const el = document.createElement('div');
      el.className = 'msg';
      el.innerHTML = `<div class="meta"><strong>${escapeHtml(m.username || m.user_id)}</strong> <small>${new Date(m.created_at).toLocaleString()}</small></div>
                      <div>${escapeHtml(m.content)}</div>`;
      messagesNode.appendChild(el);
    }

    function escapeHtml(s){ if(!s) return ''; return s.toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    // realtime subscription (v2 supabase-js)
    function subscribeToMessages(room_id) {
      // unsubscribe existing
      if (subscription) {
        try { subscription.unsubscribe(); } catch(e){console.warn(e)}
        subscription = null;
      }

      // create channel and listen for new messages in the room
      subscription = supabase.channel('public:messages')
        .on('postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'messages', filter: `room_id=eq.${room_id}` },
            payload => {
              appendMessage(payload.new);
              messagesNode.scrollTop = messagesNode.scrollHeight;
            })
        .subscribe(status => {
          console.log('sub status', status);
        });
    }

    // ---------- send message ----------
    function enableComposer(enabled){
      messageInput.disabled = !enabled;
      sendBtn.disabled = !enabled;
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage(){
      const text = messageInput.value.trim();
      if (!text) return;
      if (!currentRoom) return alert('select a room');
      const payload = {
        room_id: currentRoom.id,
        user_id: currentUser?.id || null,
        username: currentUser?.email || 'guest',
        content: text
      };
      const { error } = await supabase.from('messages').insert([payload]);
      if (error) return alert('Send failed: ' + error.message);
      messageInput.value = '';
    }

    // ---------- invite generation & redeem ----------
    inviteBtn.addEventListener('click', async () => {
      if (!currentRoom) return alert('no room');
      if (!currentUser) return alert('you must be signed in to create an invite (so we know who created it)');
      // create a token server-side ideally. For demo we create a token here:
      const token = await generateToken();
      const payload = {
        room_id: currentRoom.id,
        token: token,
        created_by: currentUser.id,
        expires_at: null,
        max_uses: 0
      };
      const { data, error } = await supabase.from('room_invites').insert([payload]).select().single();
      if (error) return alert('Could not create invite: ' + error.message);
      const url = `${location.origin}${location.pathname}?invite=${encodeURIComponent(data.token)}`;
      inviteUrl.innerHTML = `<a href="${url}">${url}</a>`;
    });

    async function joinRoomFromInvite(token) {
      // fetch invite
      const { data: invite, error } = await supabase
        .from('room_invites')
        .select('*')
        .eq('token', token)
        .limit(1)
        .single();

      if (error) throw new Error(error.message || 'Invite not found');

      // validate expiry/uses
      if (invite.expires_at && new Date(invite.expires_at) < new Date()) {
        throw new Error('Invite expired');
      }
      if (invite.max_uses && invite.max_uses > 0 && invite.uses >= invite.max_uses) {
        throw new Error('Invite reached its max uses');
      }

      // require sign-in to join (you could relax this if you want anonymous join)
      if (!currentUser) {
        // kick off magic link sign-in flow for current email if you have it
        throw new Error('Please sign in first (invite redemption requires authentication).');
      }

      // add membership
      const up = await supabase.from('room_members').upsert([{ room_id: invite.room_id, user_id: currentUser.id, username: currentUser.email || '' }]);
      if (up.error) throw new Error(up.error.message);

      // increment uses (best done via server function to avoid race)
      const inc = await supabase.from('room_invites').update({ uses: invite.uses + 1 }).eq('id', invite.id);
      if (inc.error) console.warn('Could not increment invite uses: ', inc.error.message);

      // load room
      const { data: room } = await supabase.from('rooms').select('*').eq('id', invite.room_id).single();
      await loadRooms();
      selectRoom(room);

      // remove invite= from URL for cleanliness
      const url = new URL(location.href);
      url.searchParams.delete('invite');
      history.replaceState({}, '', url.toString());
    }

    // naive token generator (client-side). For production generate tokens server-side.
    async function generateToken() {
      // try to use crypto API:
      const arr = new Uint8Array(12);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ---------- small helpers ----------
    // refresh list periodically (or wire up realtime for rooms)
    setInterval(loadRooms, 60_000);

  </script>
</body>
</html>
